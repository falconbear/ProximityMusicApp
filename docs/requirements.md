# 要件定義

## 1. 前提と目的
- 近接通信ですれ違った端末と楽曲を交換し、自動再生で偶発的な音楽体験を提供する。
- iOS/Android両対応のFlutterアプリとして提供。

## 2. ユーザーストーリー（主要）
- ユーザーとして、近くをすれ違った人から曲を受け取り、即座に再生を開始したい（初期版は即時再生を優先）。
- ユーザーとして、気分に応じてキューに溜めて後で聴く/スキップしたい（後続でプレイリスト追加を検討）。
- ユーザーとして、興味のない曲はスキップまたは送り手をブロックしたい。
- ユーザーとして、お気に入りに追加して後から聴き直したい。
- ユーザーとして、アプリを閉じてもバックグラウンドで再生と受信を続けたい。
- ユーザーとして、バッテリ消費やプライバシーについて安心できる説明を受けたい。

## 3. 機能要件（MVP範囲）
- 近接検知: 周囲端末の検知と匿名IDローテーション、接触イベントの記録。
- セッション確立: 端末間で一時的な安全なセッションを確立。
- 楽曲交換: サンプル/短尺楽曲のP2P転送、整合性チェック。初期版はリトライ省略し、失敗時は破棄。
- 再生: 即時再生を優先し、自動再生キューで連続再生。バックグラウンド再生、スキップ/一時停止、音量調整。プレイリスト追加は後続の拡張。
- コンテンツ管理: ローカル保存、ストレージ上限とクリーンアップポリシー。
- フィルタリング: ブロックリスト・お気に入り管理、ブロック時は受信/再生を停止。
- 権利/同意: 利用規約、プライバシー説明、権利クリア音源のみを扱うフロー。
- ログ/メトリクス: すれ違いイベント、転送成否、再生イベント、バッテリ関連の計測。
- オンボーディング: プライバシー・バッテリ影響の説明、権限付与(iOS/Android)。

## 4. 非機能要件
- パフォーマンス: 近接検知は一定周期で間引き、転送と再生はユーザー操作に対して1–2秒以内に反応。
- バッテリ: バックグラウンド運用時でも1時間あたりの消費を許容範囲(要実測)に収める。
- セキュリティ/プライバシー: 匿名IDローテーション、エフェメラル鍵交換、転送データ暗号化、保存データの暗号化。
- 可用性: 一時的な通信失敗に対するリトライ/フォールバック、オフライン時も再生可能。
- 運用性: ログ収集とクラッシュレポートの標準化、フィーチャーフラグで段階リリース。
- 対応OS: iOS/Androidの主要バージョン(現行+1世代)をターゲット。

## 5. 制約と前提
- 近接通信APIはOSのガイドライン内でのみ利用し、過剰なバックグラウンド動作は避ける。
- 転送する音源は権利クリア済みとし、必要に応じてサーバ側の検証を導入。
- ネットワーク/サーバレス前提でスタートし、必要に応じてBaaSを導入。

## 6. 受け入れ基準（MVP）
- 実機2種類(iOS/Android)で、すれ違い検知→セッション確立→サンプル楽曲受信→即時再生が完走する（転送失敗時はリトライせず破棄してもよい）。
- バックグラウンドでの受信・再生が動作し、過度なバッテリ消費にならないことを実測で確認。
- ブロック/スキップ/お気に入りが正しく動作し、次回以降の挙動に反映される。
- クラッシュ率が目標(例: <1% セッション)を満たし、主要ログが取得できる。
